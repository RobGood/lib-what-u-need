{
   "README" : "Write to All",
   "_dateCreated" : "Sat Apr 13 16:16:21 2013",
   "_useCount" : 169,
   "api" : {
      "add-new-item" : "(fn (i -- item name msg-log items)\n  (= item $\"new-item-$i\")\n\n  (if (eq '#!dpl\\r\\n' (substr $item 0 7))\n    (= item (eval $item)))\n\n  (= item (trim $item))\n  (= item {\n    time (time)\n    @$[item userid workspace-name remote-addr]\n  })\n\n  (= name (get-wall-log-desc-name))\n  (atomic ,$name\n    (desc-read msg-log $name)\n    (=  items (hash-get $msg-log / \"items-$i\"   ))\n    (=? items (hash-set $msg-log / \"items-$i\" []))\n    (unshift $items $item)\n    (desc-write $msg-log $name)))",
      "get-wall-log-desc-name" : "(fn () (join : [wall-msg-log @$path-list]))",
      "get-wall-name-list" : "(fn ( -- parts)\n  (foreach name (desc-list wall-msg-log*)\n    (= parts (split : $name))\n    (shift $parts)\n    (join / $parts)))"
   },
   "html" : {
      "html-form-and-wall-info" : "(fn () [\n  <table>\n  <tr>\n '<td colspan=\"4\" valign=\"top\">'\n  (html-p (if (eq '' $current-wall)\n            '<b>Top Wall</b>'\n            \"Wall: <b>${current-wall}</b>\"))\n  (html-p 'Other walls: ' $walls)\n  </td>\n  </tr>\n  <tr>\n  <td>(html-form-new-entry new-item-1)</td>\n  <td>(html-form-new-entry new-item-2)</td>\n  <td>(html-form-new-entry new-item-3)</td>\n  <td>(html-form-new-entry new-item-4)</td>\n  </tr>\n  <tr>\n  '<td valign=\"top\">'(html-previous-entries items-1)</td>\n  '<td valign=\"top\">'(html-previous-entries items-2)</td>\n  '<td valign=\"top\">'(html-previous-entries items-3)</td>\n  '<td valign=\"top\">'(html-previous-entries items-4)</td>\n  </tr>\n  </table>\n])",
      "html-form-new-entry" : "(fn (name)\n  (html-form POST \"/api/dplx/wall$path-info\" [\n    (html-textarea text $name 6 32 '')<br/>\n    '<input type=\"submit\" value=\"Post your message\"/>'\n  ]))",
      "html-one-item" : "(fn (item seq2 -- user-label when)\n  (if (undef? $item) (return ''))\n\n  (=  user-label (hash-get $item / userid))\n  (=? user-label (html-tt\n     (ip-addr-to-dns-name (hash-get $item / remote-addr))))\n\n  (= when (time-to-date (hash-get $item / time)))\n\n[\n  <table>\n  <tr><td>(sprintf '#%d %s, %s' (- $n-messages (seq++)) $when $user-label)</td></tr>\n  <tr><td>(hash-get $item / item)</td></tr>\n  </table>\n])",
      "html-page" : "(fn ( -- edit-view-url edit-view-label current-wall walls)\n  (= edit-view-url   /api/dple/wall?_workspaceName=/lib-what-u-need)\n  (= edit-view-label (if (defined? $userid) edit view))\n\n  (= current-wall (join / $path-list))\n  (= walls\n    (join ', '\n      (map-list (fn (_) (html-link \"/api/dplx/wall/$_\" $_))\n        (grep (fn (_) (ne '' $_))\n          (get-wall-name-list)))))\n\n  (html-app-template\n    (html-utility-heading $app-title [\n      'Have your say here...'\n      (bracket-link (html-link $edit-view-url \"$edit-view-label app source\"))\n    ])\n    (html-form-and-wall-info)\n  ))",
      "html-previous-entries" : "(fn (name -- seq messages msg-log n-messages)\n  (desc-read msg-log (get-wall-log-desc-name))\n\n  (= messages (hash-get $msg-log / $name))\n  (= n-messages (list-len $messages))\n  (= seq 0)\n\n[\n  (html-h 4 (concat\n              (if (== 0 $n-messages) No $n-messages)\n              ' previous message'\n              (if (== 1 $n-messages) '' s)\n  ))\n\n  // (html-table-grid $messages 4 html-one-item)\n  (map-list html-one-item $messages)\n])"
   },
   "main" : "(fn ()\n  (= $query-hash)\n\n  (map-list add-new-item\n    (grep (fn (i) (defined? $\"new-item-$i\"))\n      (.. 1 4)))\n\n  (reply-html (html-page)))",
   "on-load" : "(fn ()\n  (desc-read _ HTML-macros)\n  (desc-read _ top-page)\n\n  (= app-title 'Write to All')\n\n  (def-hash-fn $self {\n    /api [\n      add-new-item\n      get-wall-name-list\n      get-wall-log-desc-name\n    ]\n\n    /html [\n      html-page\n      html-form-new-entry\n      html-previous-entries\n      html-one-item\n      html-form-and-wall-info\n    ]\n  })\n)",
   "rcs-id" : "$Id: wall,v 1.168 2013/04/17 18:28:23 apache Exp apache $"
}
